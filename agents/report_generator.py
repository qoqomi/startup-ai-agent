# agents/report_generator.py
from graph.state import AgentState


def run(state: AgentState) -> AgentState:
    """ë³´ê³ ì„œ ìƒì„±"""
    print("\n[ë³´ê³ ì„œ ìƒì„±] ì‹œì‘")

    scores = state["final_score"]["scores"]
    decision = state["investment_decision"]

    # íŒì • ë“±ê¸‰ë³„ ì´ëª¨ì§€
    grade_emoji = {"S": "ğŸŒŸ", "A": "â­", "B": "ğŸ”¶", "C": "âš ï¸", "D": "âŒ"}

    # ìœ„í—˜ë„ë³„ ì´ëª¨ì§€
    risk_emoji = {"ë‚®ìŒ": "ğŸŸ¢", "ì¤‘ê°„": "ğŸŸ¡", "ë†’ìŒ": "ğŸ”´"}

    report = f"""
{'='*70}
ğŸš€ AI ìŠ¤íƒ€íŠ¸ì—… íˆ¬ì ë¶„ì„ ë³´ê³ ì„œ
{'='*70}

ğŸ“Š ì¢…í•© ì ìˆ˜ (100ì  ë§Œì )
{chr(10).join([f"  {'ğŸ¥‡' if i==0 else 'ğŸ¥ˆ' if i==1 else 'ğŸ¥‰' if i==2 else '  '} {s['name']}: {s['total']}ì " for i, s in enumerate(sorted(scores, key=lambda x: x['total'], reverse=True))])}

{'='*70}
ğŸ’¡ ìµœì¢… íˆ¬ì íŒë‹¨
{'='*70}
  ğŸ¢ ì¶”ì²œ ê¸°ì—…: {decision['ì¶”ì²œê¸°ì—…']}
  ğŸ¯ ìµœì¢… ì ìˆ˜: {decision['ì ìˆ˜']}ì 
  {grade_emoji.get(decision.get('íŒì •ë“±ê¸‰', 'B'), 'ğŸ”¶')} íŒì • ë“±ê¸‰: {decision.get('íŒì •ë“±ê¸‰', 'B')}ë“±ê¸‰
  ğŸ“‹ íˆ¬ì íŒì •: {decision['íŒì •']}
  {risk_emoji.get(decision.get('ìœ„í—˜ë„', 'ì¤‘ê°„'), 'ğŸŸ¡')} ìœ„í—˜ë„: {decision.get('ìœ„í—˜ë„', 'ì¤‘ê°„')}

ğŸ“Œ íˆ¬ì ì‚¬ìœ :
{chr(10).join([f"  {reason}" for reason in decision.get('íˆ¬ìì‚¬ìœ ', ['ì •ë³´ ì—†ìŒ'])])}

âš ï¸  ì£¼ì˜ì‚¬í•­:
{chr(10).join([f"  â€¢ {warning}" for warning in decision.get('ì£¼ì˜ì‚¬í•­', ['ì—†ìŒ'])])}

{'='*70}
ğŸ“‹ ìƒì„¸ í‰ê°€ í•­ëª©
{'='*70}
"""

    for s in scores:
        report += f"""
### ğŸ¢ {s['name']}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ âœ… Berkus Method (ì´ ${s['berkus']['ì´ì ']:,})
"""
        # Berkus í•­ëª©ë³„ ì ìˆ˜
        for key, value in s["berkus"].items():
            if key != "ì´ì ":
                report += f"â”‚   - {key}: ${value:,}\n"

        report += f"""â”‚
â”‚ âœ… Scorecard Method (ì´ {s['scorecard']['ì ìˆ˜']}ì )
"""
        # Scorecard í•­ëª©ë³„ ì ìˆ˜ì™€ ê°€ì¤‘ì¹˜
        if "ê°œë³„ì ìˆ˜" in s["scorecard"]:
            for key, value in s["scorecard"]["ê°œë³„ì ìˆ˜"].items():
                weight = s["scorecard"]["ê°€ì¤‘ì¹˜"].get(key, 0)
                report += f"â”‚   - {key}: {value}ì  (ê°€ì¤‘ì¹˜ {weight*100:.0f}%)\n"

        report += f"""â”‚
â”‚ âœ… ì„±ì¥ì„± ë¶„ì„
â”‚   - íŒì •: {s['growth']['íŒì •']}
â”‚   - ì£¼ê°„ ì„±ì¥ë¥ : {s['growth']['ì£¼ê°„ì„±ì¥ë¥ ']*100:.1f}%
â”‚   - ì ìˆ˜: {s['growth']['ì ìˆ˜']}ì 
â”‚
â”‚ âœ… ìƒì¡´ì„± ë¶„ì„
â”‚   - íŒì •: {s['survival']['íŒì •']}
â”‚   - ëŸ°ì›¨ì´: {s['survival']['ëŸ°ì›¨ì´']}ê°œì›”
â”‚   - ì†ìµë¶„ê¸°: {s['survival']['ì†ìµë¶„ê¸°']}ê°œì›”
â”‚   - ì ìˆ˜: {s['survival']['ì ìˆ˜']}ì 
â”‚
â”‚ âœ… PMF (Product-Market Fit)
â”‚   - ë‹¬ì„± ìˆ˜ì¤€: {s['pmf']['ë‹¬ì„±']}
â”‚   - ì‹ í˜¸ ê°œìˆ˜: {s['pmf']['ì‹ í˜¸ê°œìˆ˜']}
â”‚   - ì ìˆ˜: {s['pmf']['ì ìˆ˜']}ì 
â”‚
â”‚ ğŸ¯ ì¢…í•© ì ìˆ˜: {s['total']}ì 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

"""

    report += f"""
{'='*70}
ğŸ“Œ í‰ê°€ ê¸°ì¤€ (RAG ê¸°ë°˜)
{'='*70}
- Berkus Method: ê° í•­ëª©ë‹¹ ìµœëŒ€ $500,000
- Scorecard Method: ê²½ì˜ì§„(30%), ì‹œì¥(25%), ì œí’ˆ(15%), ê²½ìŸ(10%), íŒë§¤(10%), íˆ¬ì(5%), ê¸°íƒ€(5%)
- ì„±ì¥ì„±: ìš°ìˆ˜(10% ì´ìƒ), ì–‘í˜¸(5% ì´ìƒ), ê²½ê³ (1% ë¯¸ë§Œ)
- ìƒì¡´ì„±: Default Alive ì—¬ë¶€, ëŸ°ì›¨ì´, ì†ìµë¶„ê¸°ì 
- PMF: 6ê°€ì§€ ì‹ í˜¸ ì¤‘ 4ê°œ ì´ìƒ ì¶©ì¡± ì‹œ APMF
{'='*70}
"""

    return {**state, "report": report}
